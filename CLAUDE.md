# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

sortpics-go is a photo/video organization tool written in Go. It organizes media files into a chronological directory structure using EXIF metadata with a fallback hierarchy: EXIF → QuickTime → filename → filesystem.

This is a complete rewrite of the original Python sortpics tool, providing better performance (2-3x faster), cross-platform binaries, and improved maintainability while retaining full feature parity.

**Status**: ✅ Production ready - v0.1.0 with 90.6% test coverage (duplicate: 86.8%, pathgen: 100.0%, metadata: 94.4%, rename: 81.1%, CLI: 72.6%).

## Architecture

**Component Hierarchy & Data Flow**:

1. **internal/metadata** (94.4%) - EXIF extraction via ExifTool wrapper, datetime fallback logic, make/model normalization
2. **internal/pathgen** (100.0%) - Generates paths: `YYYY/MM/YYYY-MM-DD/YYYYMMDD-HHMMSS.subsec_Make-Model.ext`
3. **internal/duplicate** (86.8%) - SHA256 hashing, duplicate detection, collision resolution (`_N` suffix)
4. **internal/rename** (81.1%) - Orchestrates metadata → pathgen → duplicate → atomic file operations
5. **cmd/sortpics/cmd** (72.6%) - CLI framework (Cobra), worker pool, progress tracking

```
File → MetadataExtractor → PathGenerator → DuplicateDetector → ImageRename (atomic copy/move)
```

**Key Design Principles**:
- **ExifTool dependency**: Uses `github.com/barasher/go-exiftool` for 500+ format support. See DECISION.md for rationale.
- **Atomic operations**: Temp files with cleanup on error
- **Bounded concurrency**: Worker pool with backpressure and context cancellation
- **Test-driven development**: 90.6% coverage, comprehensive unit and integration tests

## Build & Test Commands

```bash
# Build
make build              # Build binaries for all platforms to ./dist/
make install            # Install platform-specific binary to ~/.local/bin
make install-global     # Install to $GOPATH/bin

# Testing
make test               # Run all tests with race detector
make test-verbose       # Verbose test output
make test-coverage      # Generate coverage.html report
make bench              # Run benchmarks
make test-fixtures      # Generate test fixture images (requires exiftool)

# Code Quality
make lint               # Run golangci-lint (requires: brew install golangci-lint)
make fmt                # Format all code
make vet                # Run go vet
make check              # Run fmt + vet + test

# Development
make run ARGS="--help"                      # Build and run
make run-dev ARGS="--dry-run /src /dest"   # Run with go run (faster iteration)
make deps               # Download dependencies
make tidy               # Tidy go modules
make clean              # Remove build artifacts
```

## Testing

**Approach**: Write tests first, maintain 90%+ coverage, use integration tests for end-to-end validation, run benchmarks to validate performance.

**Guidelines**:
- Use `github.com/stretchr/testify`: `assert.Equal(t, expected, actual)` and `require.NoError(t, err)`
- Test files: `*_test.go` in same package
- Coverage targets: 95%+ for core packages (duplicate, pathgen, metadata), 90%+ overall
- Run single package: `go test -v ./internal/pathgen`
- Run specific test: `go test -v -run TestGeneratePath ./internal/pathgen`

**Test Fixtures**:
- Located in `test/testdata/` with categories: basic, mixed, no_exif, raw, special_makes, video, collision
- Generated by `test/testdata/generate_fixtures.go` (creates real EXIF-tagged images)
- Manifest at `test/testdata/manifest.json` documents expected metadata
- Regenerate: `make test-fixtures-clean && make test-fixtures`
- Unit tests: Mock ExifTool responses
- Integration tests: Use real ExifTool with generated fixtures

## CLI Usage & Output Format

**Usage Examples**:
```bash
sortpics --copy --dry-run --recursive /sdcard /photos       # Copy with preview
sortpics --move --recursive -vvv /sdcard /photos            # Move files
sortpics --copy --raw-path /photos/raw /sdcard /photos      # Separate RAW files
sortpics --copy --album "Vacation 2024" /sdcard /photos     # Set album metadata
sortpics verify /photos                                      # Verify archive
sortpics verify --fix /photos                                # Fix verification issues
```

**Output Format**:
- **Filename**: `YYYYMMDD-HHMMSS.subsec_Make-Model.ext` (e.g., `20240315-143052.123456_Canon-EOS5D.jpg`)
  - Subsecond precision: 6 digits (configurable)
  - Make/Model: Normalized (capitalized, make prefix removed)
- **Directory**: `YYYY/MM/YYYY-MM-DD/` (e.g., `2024/03/2024-03-15/`)
- **Collisions**: Append `_N` suffix (e.g., `filename_2.jpg`)

## Development Guidelines

**Code Patterns**:
- Cross-filesystem moves: Handle `syscall.EXDEV` by falling back to copy+delete
- Atomic operations: Use `os.CreateTemp()` with UUID names, cleanup on error
- Error handling: Return wrapped errors: `fmt.Errorf("context: %w", err)`
- Defer cleanup: `defer file.Close()` and `defer os.Remove(tempFile)`

**Commit Guidelines**:
- Use conventional commits: feat, fix, refactor, docs, test, ci
- Keep messages concise and succinct
- Commit after completing logical phases

## Dependencies & Requirements

**System Requirements**:
- Go 1.21+ (using 1.24.3)
- ExifTool binary (`exiftool -ver` to verify)

**Core Dependencies**:
- `github.com/barasher/go-exiftool` v1.10.0 - ExifTool wrapper
- `github.com/spf13/cobra` v1.10.1 - CLI framework
- `github.com/alitto/pond` v1.9.2 - Worker pool
- `github.com/schollz/progressbar/v3` v3.18.0 - Progress tracking
- `github.com/stretchr/testify` v1.11.1 - Testing assertions

## Format Support

- **RAW formats**: CR2, NEF, DNG, ARW, etc. (via ExifTool)
- **Video**: MP4, MOV (QuickTime:CreateDate metadata)
- **Write capability**: Can set XMP:Album and keywords on any format

## Reference

**Important Files**:
- **DECISION.md** - Technology decisions (ExifTool wrapper vs pure Go)
- **CHANGELOG.md** - Release history and notable changes
- **Makefile** - All build targets (`make help`)
- **docs/sortpics.1** - Unix man page